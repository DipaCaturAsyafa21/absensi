<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi QR Siswa</title>
    <!-- 1. Muat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Muat Library QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Sedikit style tambahan */
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        #qr-reader {
            width: 100%;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
        }
        /* Sembunyikan footer scanner */
        
        #qr-reader__dashboard_section_csr>div>button {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto p-4 max-w-3xl">
        <header class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <h1 class="text-3xl font-bold text-center text-blue-700">Sistem Absensi QR Siswa</h1>
            <p class="text-center text-gray-600">Aplikasi demo menggunakan Local Storage</p>
        </header>

        <!-- Navigasi Tab -->
        <div class="mb-4 bg-white rounded-lg shadow-sm">
            <nav class="flex justify-around p-2">
                <button id="btn-tab-scanner" class="tab-button w-full text-center py-3 px-4 rounded-lg font-medium text-white bg-blue-600" onclick="showView('scanner')">
                    Scan Absensi
                </button>
                <button id="btn-tab-admin" class="tab-button w-full text-center py-3 px-4 rounded-lg font-medium text-gray-700" onclick="showView('admin')">
                    Manajemen & Rekap Data
                </button>
            </nav>
        </div>

        <!-- =================================== -->
        <!--      VIEW 1: HALAMAN SCANNER        -->
        <!-- =================================== -->
        <main id="view-scanner" class="space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-center mb-4">Pindai QR Code Siswa</h2>
                <!-- Di sinilah scanner QR akan muncul -->
                <div id="qr-reader" class="mx-auto max-w-sm"></div>

                <!-- Tombol untuk meminta izin kamera secara manual (jika diperlukan) -->
                <button id="start-scan-btn" class="mt-4 w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300 md:hidden">
                    Mulai Scan (jika kamera tidak aktif)
                </button>
            </div>

            <!-- Hasil Scan -->
            <div id="scan-result" class="bg-white p-6 rounded-xl shadow-lg hidden">
                <h3 class="text-xl font-semibold mb-3 text-center">Hasil Pindai Terakhir</h3>
                <div id="result-content" class="text-center">
                    <!-- Konten hasil akan dimasukkan oleh JavaScript -->
                </div>
            </div>
        </main>

        <!-- =================================== -->
        <!--    VIEW 2: HALAMAN ADMIN & REKAP    -->
        <!-- =================================== -->
        <main id="view-admin" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Filter Data Absensi</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Dari Tanggal</label>
                        <input type="date" id="filter-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="filter-end-date" class="block text-sm font-medium text-gray-700">Sampai Tanggal</label>
                        <input type="date" id="filter-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div class="flex items-end">
                        <button id="btn-filter" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                            Terapkan Filter
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Rekap Data Absensi</h2>
                    <button id="btn-export-csv" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 text-sm font-medium">
                        Ekspor ke CSV
                    </button>
                </div>

                <!-- Tabel Data -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Siswa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Absen</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data akan diisi oleh JavaScript -->
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-center text-gray-500">Tidak ada data.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ===================================
        //     KONFIGURASI & DATABASE MOCK
        // ===================================

        // Database Siswa (Mock)
        // Di aplikasi nyata, ini akan diambil dari server
        const STUDENT_DB = {
            "SISWA-001": "Budi Santoso",
            "SISWA-002": "Citra Lestari",
            "SISWA-003": "Ahmad Dahlan",
            "SISWA-004": "Dewi Anggraini",
            "SISWA-005": "Eka Wijaya"
        };

        // Kunci untuk Local Storage
        const STORAGE_KEY = "attendanceLog";

        // Variabel global untuk scanner
        let html5QrCode;
        let lastScanResult = null; // Mencegah scan berulang kali

        // ===================================
        //     LOGIKA NAVIGASI VIEW
        // ===================================

        const scannerView = document.getElementById('view-scanner');
        const adminView = document.getElementById('view-admin');
        const btnTabScanner = document.getElementById('btn-tab-scanner');
        const btnTabAdmin = document.getElementById('btn-tab-admin');

        function showView(viewName) {
            if (viewName === 'scanner') {
                scannerView.classList.remove('hidden');
                adminView.classList.add('hidden');

                btnTabScanner.classList.add('bg-blue-600', 'text-white');
                btnTabScanner.classList.remove('text-gray-700');

                btnTabAdmin.classList.add('text-gray-700');
                btnTabAdmin.classList.remove('bg-blue-600', 'text-white');

                // Mulai scanner HANYA jika view scanner aktif
                startScanner();
            } else {
                scannerView.classList.add('hidden');
                adminView.classList.remove('hidden');

                btnTabScanner.classList.add('text-gray-700');
                btnTabScanner.classList.remove('bg-blue-600', 'text-white');

                btnTabAdmin.classList.add('bg-blue-600', 'text-white');
                btnTabAdmin.classList.remove('text-gray-700');

                // Hentikan scanner jika pindah view
                stopScanner();

                // Muat data admin saat pindah
                loadAdminData();
            }
        }

        // ===================================
        //     LOGIKA SCANNER QR
        // ===================================

        // Fungsi callback saat scan berhasil
        function onScanSuccess(decodedText, decodedResult) {
            // `decodedText` adalah isi dari QR code

            // Mencegah scan berulang untuk hasil yang sama
            if (decodedText === lastScanResult) {
                return;
            }
            lastScanResult = decodedText;

            console.log(`Hasil Pindai: ${decodedText}`, decodedResult);

            const studentName = STUDENT_DB[decodedText];
            const resultDiv = document.getElementById('scan-result');
            const resultContent = document.getElementById('result-content');

            if (studentName) {
                // Siswa ditemukan
                const timestamp = new Date();
                const record = {
                    studentId: decodedText,
                    studentName: studentName,
                    timestamp: timestamp.toISOString()
                };

                saveAttendance(record);

                resultContent.innerHTML = `
                    <p class="text-2xl font-bold text-green-600">BERHASIL!</p>
                    <p class="text-lg text-gray-800">${studentName} (${decodedText})</p>
                    <p class="text-gray-600">Tercatat pada: ${timestamp.toLocaleString('id-ID')}</p>
                `;
                resultDiv.className = 'bg-green-50 p-6 rounded-xl shadow-lg';

            } else {
                // Siswa tidak ditemukan / QR tidak valid
                resultContent.innerHTML = `
                    <p class="text-2xl font-bold text-red-600">GAGAL!</p>
                    <p class="text-lg text-gray-800">QR Code tidak valid atau siswa tidak terdaftar.</p>
                    <p class="text-gray-600">Data QR: ${decodedText}</p>
                `;
                resultDiv.className = 'bg-red-50 p-6 rounded-xl shadow-lg';
            }

            // Tampilkan hasil selama 5 detik
            resultDiv.classList.remove('hidden');
            setTimeout(() => {
                resultDiv.classList.add('hidden');
                lastScanResult = null; // Reset last scan
            }, 5000);
        }

        // Fungsi callback saat scan gagal (opsional)
        function onScanFailure(error) {
            // console.warn(`Scan error: ${error}`);
        }

        function startScanner() {
            // Hanya inisialisasi jika belum ada
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            // Konfigurasi scanner
            const config = {
                fps: 10,
                qrbox: {
                    width: 250,
                    height: 250
                }
            };

            // Coba mulai scanner
            html5QrCode.start({
                    facingMode: "environment"
                }, // Kamera belakang
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("Gagal memulai scanner:", err);
                // Jika gagal (misal: di desktop tanpa kamera), tampilkan pesan
                if (document.getElementById('view-scanner').classList.contains('hidden') === false) {
                    document.getElementById('qr-reader').innerHTML = `
                        <p class="text-center text-red-600 p-4">
                            Tidak dapat mengakses kamera. Pastikan Anda memberikan izin kamera.
                        </p>
                     `;
                }
            });
        }

        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log("QR Scanner dihentikan.");
                }).catch(err => {
                    console.error("Gagal menghentikan scanner:", err);
                });
            }
        }

        // ===================================
        //     LOGIKA PENYIMPANAN DATA
        // ===================================

        function getAttendanceLog() {
            const log = localStorage.getItem(STORAGE_KEY);
            return log ? JSON.parse(log) : [];
        }

        function saveAttendance(record) {
            const log = getAttendanceLog();
            log.push(record);
            // Urutkan dari yang terbaru
            log.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            localStorage.setItem(STORAGE_KEY, JSON.stringify(log));
        }

        // ===================================
        //    LOGIKA ADMIN, FILTER, & REKAP
        // ===================================

        const startDateInput = document.getElementById('filter-start-date');
        const endDateInput = document.getElementById('filter-end-date');
        const filterButton = document.getElementById('btn-filter');
        const exportButton = document.getElementById('btn-export-csv');
        const tableBody = document.getElementById('attendance-table-body');

        // Atur tanggal default ke hari ini
        const today = new Date().toISOString().split('T')[0];
        startDateInput.value = today;
        endDateInput.value = today;

        filterButton.addEventListener('click', loadAdminData);
        exportButton.addEventListener('click', exportCSV);

        function loadAdminData() {
            const log = getAttendanceLog();

            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            if (startDate) {
                startDate.setHours(0, 0, 0, 0); // Mulai hari
            }
            if (endDate) {
                endDate.setHours(23, 59, 59, 999); // Akhir hari
            }

            const filteredLog = log.filter(record => {
                const recordDate = new Date(record.timestamp);

                const afterStart = startDate ? recordDate >= startDate : true;
                const beforeEnd = endDate ? recordDate <= endDate : true;

                return afterStart && beforeEnd;
            });

            renderTable(filteredLog);
        }

        function renderTable(data) {
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Tidak ada data untuk rentang tanggal ini.</td></tr>`;
                return;
            }

            tableBody.innerHTML = ''; // Kosongkan tabel
            data.forEach(record => {
                const timestamp = new Date(record.timestamp).toLocaleString('id-ID', {
                    dateStyle: 'medium',
                    timeStyle: 'medium'
                });

                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.studentId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${record.studentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${timestamp}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function exportCSV() {
            // Dapatkan data yang sedang terfilter saat ini
            const log = getFilteredData();

            if (log.length === 0) {
                alert("Tidak ada data untuk diekspor!");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            // Header
            csvContent += "ID Siswa,Nama Siswa,Waktu Absen\r\n";

            // Baris data
            log.forEach(record => {
                const timestamp = new Date(record.timestamp).toLocaleString('id-ID');
                csvContent += `"${record.studentId}","${record.studentName}","${timestamp}"\r\n`;
            });

            // Buat link dan download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "rekap_absensi.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getFilteredData() {
            const log = getAttendanceLog();
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
            if (startDate) startDate.setHours(0, 0, 0, 0);
            if (endDate) endDate.setHours(23, 59, 59, 999);

            return log.filter(record => {
                const recordDate = new Date(record.timestamp);
                const afterStart = startDate ? recordDate >= startDate : true;
                const beforeEnd = endDate ? recordDate <= endDate : true;
                return afterStart && beforeEnd;
            });
        }

        // ===================================
        //     INISIALISASI APLIKASI
        // ===================================

        // Saat halaman dimuat, tampilkan view scanner
        document.addEventListener('DOMContentLoaded', () => {
            showView('scanner');
        });

        // Handle tombol start manual di HP
        document.getElementById('start-scan-btn').addEventListener('click', () => {
            startScanner();
        });
    </script>
</body>

</html>